generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma-client"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Tenant {
  id                 String                @id
  slug               String                @unique
  name               String
  status             String
  createdAt          DateTime
  updatedAt          DateTime
  domains            TenantDomain[]
  websiteConfig      WebsiteConfig?
  controlSettings    TenantControlSettings?
  billingSubscription TenantBillingSubscription?
  controlActors      TenantControlActor[]
  onboardingPlans    TenantOnboardingPlan[]
  onboardingTasks    TenantOnboardingTask[]
  contacts           Contact[]
  leads              Lead[]
  activities         Activity[]
  ingestedEvents     IngestedEvent[]
  ingestionQueueJobs IngestionQueueJob[]
  transactions       Transaction[]
  integrationTokens  IntegrationToken[]
}

model TenantDomain {
  id                 String   @id
  tenantId           String
  hostname           String
  hostnameNormalized String   @unique
  status             String   @default("active")
  isPrimary          Boolean  @default(false)
  isVerified         Boolean  @default(false)
  verifiedAt         DateTime?
  createdAt          DateTime
  updatedAt          DateTime
  tenant             Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
}

model WebsiteConfig {
  id        String         @id
  tenantId  String         @unique
  createdAt DateTime
  updatedAt DateTime
  tenant    Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  modules   ModuleConfig[]
}

model TenantControlSettings {
  id               String   @id
  tenantId         String   @unique
  status           String   @default("active")
  planCode         String   @default("starter")
  featureFlagsJson String   @default("[]")
  createdAt        DateTime
  updatedAt        DateTime
  tenant           Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model TenantBillingSubscription {
  id                   String   @id
  tenantId             String   @unique
  planCode             String   @default("starter")
  status               String   @default("trialing")
  paymentStatus        String   @default("pending")
  billingProvider      String   @default("manual")
  billingCustomerId    String?
  billingSubscriptionId String?
  trialEndsAt          DateTime?
  currentPeriodEndsAt  DateTime?
  cancelAtPeriodEnd    Boolean  @default(false)
  createdAt            DateTime
  updatedAt            DateTime
  tenant               Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model TenantBillingSyncEvent {
  id            String   @id
  tenantId      String?
  provider      String
  eventId       String
  eventType     String
  payloadJson   String
  resultStatus  String
  resultMessage String?
  createdAt     DateTime
  processedAt   DateTime

  @@unique([provider, eventId])
  @@index([tenantId, createdAt])
}

model TenantControlActor {
  id                     String   @id
  tenantId               String
  actorId                String
  displayName            String?
  email                  String?
  role                   String
  permissionsJson        String   @default("[]")
  supportSessionActive   Boolean  @default(false)
  supportSessionStartedAt DateTime?
  supportSessionExpiresAt DateTime?
  createdAt              DateTime
  updatedAt              DateTime
  tenant                 Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, actorId])
  @@index([tenantId, role])
}

model TenantOnboardingPlan {
  id               String   @id
  tenantId         String
  status           String   @default("active")
  planCode         String
  startedAt        DateTime?
  targetLaunchDate DateTime?
  completedAt      DateTime?
  pausedAt         DateTime?
  pauseReason      String?
  createdAt        DateTime
  updatedAt        DateTime
  tenant           Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tasks            TenantOnboardingTask[]

  @@index([tenantId, status])
  @@index([tenantId, createdAt])
}

model TenantOnboardingTask {
  id                    String   @id
  tenantOnboardingPlanId String
  tenantId              String
  taskKey               String
  title                 String
  description           String?
  status                String   @default("pending")
  priority              String   @default("normal")
  required              Boolean  @default(true)
  ownerRole             String   @default("ops")
  ownerActorId          String?
  dueAt                 DateTime?
  blockedByClient       Boolean  @default(false)
  blockerReason         String?
  sortOrder             Int      @default(0)
  completedAt           DateTime?
  createdAt             DateTime
  updatedAt             DateTime
  tenant                Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  onboardingPlan        TenantOnboardingPlan @relation(fields: [tenantOnboardingPlanId], references: [id], onDelete: Cascade)

  @@index([tenantId, status])
  @@index([tenantId, dueAt])
  @@index([tenantOnboardingPlanId, sortOrder])
  @@unique([tenantOnboardingPlanId, taskKey])
}

model ModuleConfig {
  id              String        @id
  websiteConfigId String
  tenantId        String
  moduleKey       String
  enabled         Boolean       @default(true)
  sortOrder       Int           @default(0)
  createdAt       DateTime
  updatedAt       DateTime
  websiteConfig   WebsiteConfig @relation(fields: [websiteConfigId], references: [id], onDelete: Cascade)

  @@unique([websiteConfigId, moduleKey])
  @@index([tenantId])
}

model Contact {
  id              String   @id
  tenantId        String
  fullName        String?
  email           String?
  emailNormalized String?
  phone           String?
  phoneNormalized String?
  source          String
  createdAt       DateTime
  updatedAt       DateTime
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  leads           Lead[]
  activities      Activity[]

  @@index([tenantId, createdAt])
  @@unique([tenantId, emailNormalized])
  @@unique([tenantId, phoneNormalized])
}

model Lead {
  id             String     @id
  tenantId       String
  contactId      String?
  status         String
  leadType       String
  source         String
  timeframe      String?
  notes          String?
  listingId      String?
  listingUrl     String?
  listingAddress String?
  propertyType   String?
  beds           Int?
  baths          Int?
  sqft           Int?
  lastContactAt  DateTime?
  nextActionAt   DateTime?
  nextActionNote      String?
  nextActionChannel   String?
  reminderSnoozedUntil DateTime?
  priceMin       Int?
  priceMax       Int?
  tags           String     @default("[]")
  closeReason    String?
  closeNotes     String?
  closedAt       DateTime?
  assignedTo     String?
  referredBy     String?
  createdAt      DateTime
  updatedAt      DateTime
  tenant         Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contact        Contact?   @relation(fields: [contactId], references: [id], onDelete: SetNull)
  activities     Activity[]

  @@index([tenantId, createdAt])
  @@index([contactId])
}

model Activity {
  id           String   @id
  tenantId     String
  contactId    String?
  leadId       String?
  activityType String
  occurredAt   DateTime
  summary      String
  metadataJson String?
  createdAt    DateTime
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contact      Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)
  lead         Lead?    @relation(fields: [leadId], references: [id], onDelete: SetNull)

  @@index([tenantId, occurredAt])
  @@index([contactId])
  @@index([leadId])
}

model IngestedEvent {
  id         String   @id
  tenantId   String
  eventType  String
  eventKey   String
  occurredAt DateTime
  payloadJson String
  processedAt DateTime
  createdAt  DateTime
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, processedAt])
  @@unique([tenantId, eventKey])
}

model IngestionQueueJob {
  id          String   @id
  tenantId    String
  eventType   String
  eventKey    String
  occurredAt  DateTime
  payloadJson String
  status      String
  attemptCount Int     @default(0)
  lastError   String?
  createdAt   DateTime
  updatedAt   DateTime
  processedAt DateTime?
  nextAttemptAt DateTime @default(now())
  deadLetteredAt DateTime?
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, status, createdAt])
  @@index([status, createdAt])
  @@index([status, nextAttemptAt])
  @@unique([tenantId, eventKey])
}

model AdminAuditEvent {
  id           String   @id
  tenantId     String?
  domainId     String?
  action       String
  status       String
  actorId      String?
  actorRole    String
  error        String?
  metadataJson String?
  createdAt    DateTime

  @@index([tenantId, createdAt])
  @@index([action, createdAt])
  @@index([status, createdAt])
}

model Transaction {
  id              String    @id
  tenantId        String
  leadId          String?
  contactId       String?
  propertyAddress String
  status          String
  side            String
  salePrice       Int?
  listPrice       Int?
  closingDate     DateTime?
  contractDate    DateTime?
  inspectionDate  DateTime?
  appraisalDate   DateTime?
  titleDate       DateTime?
  notes           String?
  createdAt       DateTime
  updatedAt       DateTime
  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  parties         TransactionParty[]
  documents       TransactionDocument[]
  milestones      TransactionMilestone[]

  @@index([tenantId, status])
  @@index([tenantId, createdAt])
}

model TransactionParty {
  id            String      @id
  transactionId String
  tenantId      String
  role          String
  name          String
  email         String?
  phone         String?
  company       String?
  createdAt     DateTime
  updatedAt     DateTime
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@index([transactionId])
  @@index([tenantId])
}

model TransactionDocument {
  id            String      @id
  transactionId String
  tenantId      String
  documentType  String
  fileName      String
  status        String      @default("pending")
  notes         String?
  createdAt     DateTime
  updatedAt     DateTime
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@index([transactionId])
  @@index([tenantId])
}

model TransactionMilestone {
  id            String      @id
  transactionId String
  tenantId      String
  milestoneType String
  scheduledAt   DateTime?
  completedAt   DateTime?
  createdAt     DateTime
  updatedAt     DateTime
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@index([transactionId])
  @@index([tenantId])
}

model IntegrationToken {
  id              String    @id
  tenantId        String
  actorId         String
  provider        String
  accessTokenEnc  String
  refreshTokenEnc String
  scopesJson      String    @default("[]")
  expiresAt       DateTime?
  createdAt       DateTime
  updatedAt       DateTime
  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, actorId, provider])
  @@index([tenantId, provider])
}
